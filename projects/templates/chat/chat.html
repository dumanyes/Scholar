{% extends "users/base.html" %}
{% load static %}

{% block content %}
<style>
  /* Optional body background override */
  body {
    background-color: #0f172a; /* dark navy */
  }
</style>

<div class="w-full h-screen flex flex-col text-gray-100">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 bg-gray-900 shadow">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center text-white font-medium text-lg shadow-sm">
        {{ other_user.username|first|upper }}
      </div>
      <div>
        <h2 class="font-semibold text-gray-100">@{{ other_user.username }}</h2>
        <p class="text-xs text-gray-400">
          {% if other_user.is_online %}
            <span class="inline-block w-2 h-2 mr-1 bg-green-500 rounded-full"></span> Online
          {% else %}
            Last seen {% now "jS F" %}
          {% endif %}
        </p>
      </div>
    </div>
    <div>
      <a href="{% url 'marketplace' %}" class="text-sm text-gray-300 hover:text-gray-100 transition">
        Back to Marketplace
      </a>
    </div>
  </div>

  <!-- Messages Container -->
  <div id="message-list" class="flex-1 overflow-y-auto bg-gray-800 px-6 py-4">
    {% for message in chat_messages %}
      <div class="{% if message.sender == request.user %}ml-auto max-w-[75%] flex flex-col items-end{% else %}mr-auto max-w-[75%]{% endif %} mb-4">
        <div class="flex items-end gap-2">
          {% if message.sender != request.user %}
            {% if message.sender.profile.avatar %}
  <img src="{{ message.sender.profile.avatar.url }}" alt="{{ message.sender.username }}" class="w-8 h-8 rounded-full object-cover">
{% else %}
  <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs">
    {{ message.sender.username|first|upper }}
  </div>
{% endif %}

          {% endif %}
          <!-- Chat bubble -->
          <div class="{% if message.sender == request.user %}bg-blue-600 text-white rounded-2xl rounded-tr-none{% else %}bg-gray-700 text-gray-100 rounded-2xl rounded-tl-none{% endif %} px-4 py-3 shadow-sm">
            <p class="text-sm">{{ message.content }}</p>
          </div>
        </div>
        <span class="text-xs text-gray-400 mt-1">
          {{ message.timestamp|date:"H:i" }}
        </span>
      </div>
    {% empty %}
      <div class="flex flex-col items-center justify-center h-full text-center text-gray-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3 class="text-lg font-medium">No messages yet</h3>
        <p class="mt-1">Start the conversation with {{ other_user.username }}</p>
      </div>
    {% endfor %}
  </div>

  <!-- Message Input -->
  <form method="POST" class="border-t border-gray-700 bg-gray-900 p-4">
    {% csrf_token %}
    <div class="flex items-center gap-3">
      <textarea name="content" rows="1"
        class="block w-full px-4 py-2 text-sm bg-gray-700 border-0 rounded-full focus:ring-2 focus:ring-blue-500 resize-none text-gray-100"
        placeholder="Type your message..."></textarea>
      <button type="submit"
        class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 shadow-md transition duration-200">
        <!-- Send Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
        </svg>
      </button>
    </div>
  </form>
</div>

<script>
  // Auto-scroll to bottom of messages
  const messageList = document.getElementById('message-list');
  messageList.scrollTop = messageList.scrollHeight;

  // Auto-expand textarea
  const textarea = document.querySelector('textarea[name="content"]');
  textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    if (this.scrollHeight > 200) {
      this.style.height = '200px';
    }
  });
</script>

<script>
  // Open a WebSocket connection for real-time messages.
  const roomName = "lobby";  // Adjust as needed (or derive from URL/JS variable)
  const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log("New message:", data.message);
    // Append the new message to the chat container.
    const messageList = document.getElementById('message-list');
    const messageDiv = document.createElement('div');
    // Determine sender side (if sender is current user, adjust styling accordingly)
    let senderSideClass = "mr-auto max-w-[75%] mb-4";
    if (data.sender === "{{ request.user.username }}") {
      senderSideClass = "ml-auto max-w-[75%] flex flex-col items-end mb-4";
    }
    // Build avatar block: if sender_avatar is provided, display image; otherwise fallback.
    let avatarHTML = "";
    if (data.sender !== "{{ request.user.username }}") {
      if (data.sender_avatar) {
        avatarHTML = `<img src="${data.sender_avatar}" alt="${data.sender}" class="w-8 h-8 rounded-full object-cover">`;
      } else {
        avatarHTML = `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs">
                        ${data.sender ? data.sender[0].toUpperCase() : ''}
                      </div>`;
      }
    }
    messageDiv.className = senderSideClass;
    messageDiv.innerHTML = `
      <div class="flex items-end gap-2">
        ${ avatarHTML }
        <div class="bg-gray-700 text-gray-100 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
          <p class="text-sm">${data.message}</p>
        </div>
      </div>
      <span class="text-xs text-gray-400 mt-1">${data.timestamp || ''}</span>
    `;
    messageList.appendChild(messageDiv);
    messageList.scrollTop = messageList.scrollHeight;
  };

  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };

  // To send a message using the WebSocket:
  function sendMessage(message) {
    chatSocket.send(JSON.stringify({'message': message}));
  }
</script>

{% endblock %}

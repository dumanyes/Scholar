{% extends "users/base.html" %}
{% load static %}
{% load project_tags %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Explore Research Projects</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1A365D',
            'primary-light': '#2D4A7A',
            secondary: '#F0B429',
            tertiary: '#48BB78',
            background: '#F7FAFC',
            paper: '#FFFFFF',
            text: '#2D3748',
            'text-light': '#718096',
            border: '#E2E8F0',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header -->
    <header class="mb-12 text-center">
      <h1 class="text-4xl font-bold text-gray-800 mb-8">Explore Research Projects</h1>

      <!-- Navigation Bar -->
      <div class="flex flex-wrap justify-center gap-3">
        <a href="{% url 'my-projects' %}" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all">
          <i class="fas fa-folder-open text-gray-500"></i> My Projects
        </a>
        <a href="{% url 'my-requests' %}" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all">
          <i class="fas fa-paper-plane text-gray-500"></i> My Requests
        </a>
        <a href="{% url 'favorites' %}" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all">
          <i class="fas fa-heart text-gray-500"></i> Favorites
        </a>

        {% if current_query or time_filter or selected_categories|join:"" or selected_skills|join:"" or selected_languages|join:"" %}
          <button onclick="toggleFilterDialog()" class="px-4 py-2.5 bg-blue-50 rounded-lg shadow-sm text-blue-600 hover:bg-blue-100 flex items-center gap-2 transition-all">
            <i class="fas fa-filter"></i> Filters (Active)
          </button>
        {% else %}
          <button onclick="toggleFilterDialog()" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all">
            <i class="fas fa-filter text-gray-500"></i> Filters
          </button>
        {% endif %}

        <a href="{% url 'chat_list' %}" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all relative">
          <i class="fas fa-comments text-gray-500"></i> Chats
          {% if unread_chat_count and unread_chat_count > 0 %}
            <span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
              {{ unread_chat_count }}
            </span>
          {% endif %}
        </a>

        <a href="{% url 'notifications_list' %}" class="px-4 py-2.5 bg-white rounded-lg shadow-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition-all relative">
          <i class="fas fa-bell text-gray-500"></i> Notifications
          {% if notifications_count and notifications_count > 0 %}
            <span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
              {{ notifications_count }}
            </span>
          {% endif %}
        </a>
      </div>
    </header>

    <!-- Search Bar -->
    <div class="max-w-2xl mx-auto mb-8">
      <form id="searchForm" method="GET">
        <div class="relative">
          <input type="text" id="searchInput" name="q" value="{{ current_query }}" placeholder="Search research projects..."
            class="w-full px-5 py-3 pl-12 rounded-xl border border-gray-200 bg-white shadow-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition-all focus:outline-none">
          <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition-all">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
    </div>

    <!-- Active Filters Display -->
    {% if current_query or time_filter or selected_categories|join:"" or selected_skills|join:"" %}
      <div class="mb-8 bg-white p-4 rounded-xl shadow-sm">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-medium text-gray-700">Active Filters</h4>
          <button onclick="clearFilters(); document.getElementById('filterForm').submit();" class="text-sm text-red-500 hover:text-red-600">
            Clear All
          </button>
        </div>
        <div class="flex flex-wrap gap-2">
        {% for lang_id in selected_languages %}
  {% for lang in languages %}
    {% if lang.id|stringformat:"s" == lang_id %}
      <span class="px-3 py-1 bg-blue-50 rounded-full text-sm text-blue-700 flex items-center gap-1">
        Language: {{ lang.name }}
        <button onclick="toggleLanguageFilter('{{ lang_id }}'); document.getElementById('filterForm').submit();" class="ml-1 text-blue-500 hover:text-blue-700">
          <i class="fas fa-times-circle"></i>
        </button>
      </span>
    {% endif %}
  {% endfor %}
{% endfor %}

          {% if current_query %}
            <span class="px-3 py-1 bg-blue-50 rounded-full text-sm text-blue-700 flex items-center gap-1">
              Search: "{{ current_query }}"
              <button onclick="document.getElementById('searchInput').value = ''; document.getElementById('searchForm').submit();" class="ml-1 text-blue-500 hover:text-blue-700">
                <i class="fas fa-times-circle"></i>
              </button>
            </span>
          {% endif %}

          {% if time_filter %}
            <span class="px-3 py-1 bg-blue-50 rounded-full text-sm text-blue-700 flex items-center gap-1">
              Time:
              {% if time_filter == 'last_24_hours' %}Last 24 Hours
              {% elif time_filter == 'last_week' %}Last Week
              {% elif time_filter == 'last_month' %}Last Month
              {% elif time_filter == 'last_year' %}Last Year
              {% elif time_filter == 'custom' %}
                {% if date_from and date_to %}{{ date_from }} to {{ date_to }}{% else %}Custom Range{% endif %}
              {% endif %}
              <button onclick="setTimeFilter(''); document.getElementById('filterForm').submit();" class="ml-1 text-blue-500 hover:text-blue-700">
                <i class="fas fa-times-circle"></i>
              </button>
            </span>
          {% endif %}

          {% for cat in selected_categories %}
            {% for category in all_categories %}
              {% if category.id|stringformat:"s" == cat %}
                <span class="px-3 py-1 bg-blue-50 rounded-full text-sm text-blue-700 flex items-center gap-1">
                  Category: {{ category.name }}
                  <button onclick="toggleCategoryFilter('{{ cat }}'); document.getElementById('filterForm').submit();" class="ml-1 text-blue-500 hover:text-blue-700">
                    <i class="fas fa-times-circle"></i>
                  </button>
                </span>
              {% endif %}
            {% endfor %}
          {% endfor %}

          {% for skill in selected_skills %}
            <span class="px-3 py-1 bg-blue-50 rounded-full text-sm text-blue-700 flex items-center gap-1">
              Skill: {{ skill }}
              <button onclick="removeSkillTag('{{ skill }}'); document.getElementById('filterForm').submit();" class="ml-1 text-blue-500 hover:text-blue-700">
                <i class="fas fa-times-circle"></i>
              </button>
            </span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Profile Completion Alert -->
    {% if request.user.profile.categories.all|length == 0 or request.user.profile.skills.all|length == 0 %}
      <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-8 rounded-r-lg flex items-start gap-3">
        <i class="fas fa-exclamation-circle text-amber-500 text-xl mt-0.5"></i>
        <div>
          {% if request.user.profile.categories.all|length == 0 and request.user.profile.skills.all|length == 0 %}
            <p class="font-medium text-amber-800">To see recommended projects, please indicate your research areas and skills.</p>
          {% elif request.user.profile.categories.all|length == 0 %}
            <p class="font-medium text-amber-800">To see recommended projects, please indicate your research areas.</p>
          {% elif request.user.profile.skills.all|length == 0 %}
            <p class="font-medium text-amber-800">To see recommended projects, please select your skills.</p>
          {% endif %}
          <a href="{% url 'users-edit-profile' %}" class="inline-block mt-2 text-blue-600 hover:text-blue-800 font-medium">Update your profile →</a>
        </div>
      </div>
    {% endif %}

    <!-- Recommended Projects Section -->
    {% if recommended_projects %}
      <section class="mb-12">
        <div class="flex items-center gap-2 mb-6">
          <span class="text-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
          </span>
          <h2 class="text-2xl font-bold text-gray-800">Recommended for You</h2>
        </div>

        <div class="space-y-6">
          {% for project in recommended_projects %}
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 hover:shadow-md transition-all duration-300">
              <div class="md:flex">
                <!-- Project Info -->
                <div class="p-5 md:w-2/3 relative">
                  <!-- Favorite Button -->
                  <button onclick="saveProject({{ project.id }})" id="fav-btn-{{ project.id }}" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 focus:outline-none transition-all" aria-label="{% if project.id in favorite_ids %}Remove from favorites{% else %}Add to favorites{% endif %}">
                    {% if project.id in favorite_ids %}
                      <i class="fas fa-heart text-red-500"></i>
                    {% else %}
                      <i class="far fa-heart text-gray-400 hover:text-red-400"></i>
                    {% endif %}
                  </button>

                  <!-- Categories & Badges -->
                  <div class="flex flex-wrap gap-2 mb-3">
                    {% if project.view_count > 500 %}
                      <span class="inline-flex items-center px-2.5 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">
                        <i class="fas fa-fire-alt mr-1"></i> Trending
                      </span>
                    {% endif %}

                    {% for category in project.category.all %}
                      <a href="#" onclick="setCategoryFilter('{{ category.id }}')" class="inline-flex items-center px-2.5 py-1 bg-gray-100 hover:bg-gray-200 text-xs font-medium rounded-full text-gray-700 transition-colors">
                        {{ category.name }}
                      </a>
                    {% endfor %}

                    {% if request.user.profile.categories.all|length and request.user.profile.skills.all|length and project.faiss_score %}
                      <span class="inline-flex items-center px-2.5 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                        <i class="fas fa-star mr-1"></i> {{ project.faiss_score }}% Match
                      </span>
                    {% endif %}
                  </div>

                  <!-- Project Title -->
                  <h3 class="text-xl font-bold mb-2 text-gray-800">{{ project.title }}</h3>

                  <!-- Posted Date -->
                  <div class="text-sm text-gray-500 mb-3">
                    <i class="fas fa-clock mr-1.5 text-gray-400"></i> Posted {{ project.created_at|timesince }} ago
                  </div>

                  <!-- Description -->
                  <div class="mb-4">
                    <p id="desc-{{ project.id }}" class="text-gray-600 text-sm line-clamp-3">
                      {{ project.description }}
                    </p>
                    <button onclick="toggleDescription('desc-{{ project.id }}', event)" class="text-sm text-blue-600 hover:text-blue-800 mt-1 flex items-center focus:outline-none">
                      <span class="read-more-text">Read more</span>
                      <span class="read-less-text hidden">Read less</span>
                      <i class="fas fa-chevron-down ml-1 read-more-icon"></i>
                      <i class="fas fa-chevron-up ml-1 read-less-icon hidden"></i>
                    </button>
                  </div>

                  <!-- Project Owner -->
                  <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <a href="{% url 'project-user-profile' project.owner.username %}">
                      <img src="{{ project.owner.profile.avatar_url }}" alt="{{ project.owner.username }}" class="w-10 h-10 rounded-full object-cover">
                    </a>
                    <div>
                      <a href="{% url 'project-user-profile' project.owner.username %}" class="font-medium text-gray-800 hover:text-blue-600">
                        @{{ project.owner.username }}
                      </a>
                      {% if project.owner.profile.city or project.owner.profile.country %}
                        <p class="text-xs text-gray-500 flex items-center mt-0.5">
                          <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                          {% if project.owner.profile.city %}{{ project.owner.profile.city }}{% endif %}
                          {% if project.owner.profile.city and project.owner.profile.country %} · {% endif %}
                          {% if project.owner.profile.country %}{{ project.owner.profile.country }}{% endif %}
                        </p>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <!-- Project Stats & Actions -->
                <div class="bg-gray-50 p-5 md:w-1/3 border-t md:border-t-0 md:border-l border-gray-100">
                  <!-- Required Roles -->
                  {% if project.required_roles.all %}
                    <div class="mb-4">
                      <h4 class="text-sm font-medium text-gray-700 mb-2">Required Roles:</h4>
                      <div class="flex flex-wrap gap-1.5">
                        {% for role in project.required_roles.all %}
                          <span class="px-2.5 py-1 bg-blue-50 text-blue-700 text-xs font-medium rounded-full">
                            <i class="fas fa-user-tag mr-1"></i> {{ role.name }}
                          </span>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  <!-- Skill Match -->
                  {% with match=project|skill_match:user %}
                    <div class="mb-4">
                      <div class="flex justify-between items-center mb-1">
                        <h4 class="text-sm font-medium text-gray-700">Skill Match</h4>
                        <p class="text-sm font-medium {% if match <= 30 %}text-yellow-600{% elif match <= 60 %}text-green-600{% else %}text-blue-600{% endif %}">
                          {{ match }}%
                        </p>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full {% if match <= 30 %}bg-yellow-500{% elif match <= 60 %}bg-green-500{% else %}bg-blue-500{% endif %}" style="width: {{ match }}%;"></div>
                      </div>
                    </div>
                  {% endwith %}

                  <!-- Project Stats -->
                  <div class="mb-4 p-3 bg-white rounded-lg border border-gray-100">
                    <div class="flex justify-between text-sm text-gray-600 mb-1.5">
                      <span class="flex items-center">
                        <i class="fas fa-eye mr-1.5 text-gray-400"></i> {{ project.view_count }} Views
                      </span>
                      <span class="flex items-center">
                        <i class="fas fa-calendar-alt mr-1.5 text-gray-400"></i> {{ project.created_at|date:"M d, Y" }}
                      </span>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="space-y-2">
                    <a href="{% url 'project-detail' pk=project.pk %}" class="block w-full py-2 bg-white border border-gray-300 rounded-lg text-center font-medium text-gray-700 hover:bg-gray-50 transition-all">
                      View Details
                    </a>

                    {% if project.owner != request.user %}
                      {% if project.application_status %}
                        {% if project.application_status == 'PENDING' %}
                          <a href="{% url 'withdraw-application' project_id=project.id %}" class="block w-full py-2 bg-red-600 rounded-lg text-center font-medium text-white hover:bg-red-700 transition-all">
                            Withdraw Application
                          </a>
                        {% elif project.application_status == 'ACCEPTED' %}
                          <a href="{% url 'chat' user_id=project.owner.id %}" class="block w-full py-2 bg-blue-600 rounded-lg text-center font-medium text-white hover:bg-blue-700 transition-all">
                            Chat with Owner
                          </a>
                        {% else %}
                          <button disabled class="block w-full py-2 bg-gray-300 rounded-lg text-center font-medium text-white cursor-not-allowed">
                            {{ project.application_status|title }}
                          </button>
                        {% endif %}
                      {% else %}
                        <a href="{% url 'apply-project' project_id=project.id %}" class="block w-full py-2 bg-blue-600 rounded-lg text-center font-medium text-white hover:bg-blue-700 transition-all">
                          Apply Now
                        </a>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {% if recommended_is_paginated %}
  <div class="flex justify-center mt-6">
    <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% if recommended_projects.has_previous %}
        <a href="?rec_page={{ recommended_projects.previous_page_number }}" class="px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-l-md hover:bg-gray-50">Previous</a>
      {% endif %}
      {% for num in recommended_projects.paginator.page_range %}
        {% if recommended_projects.number == num %}
          <span class="px-4 py-2 bg-blue-50 border border-gray-300 text-blue-700">{{ num }}</span>
        {% else %}
          <a href="?rec_page={{ num }}" class="px-4 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">{{ num }}</a>
        {% endif %}
      {% endfor %}
      {% if recommended_projects.has_next %}
        <a href="?rec_page={{ recommended_projects.next_page_number }}" class="px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-r-md hover:bg-gray-50">Next</a>
      {% endif %}
    </nav>
  </div>
{% endif %}

    <!-- All Projects Section -->
    {% if projects %}
      <section class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-800">All Projects</h2>
          <a href="{% url 'view-all-recommended' %}" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-all flex items-center text-sm">
            View All Projects
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" class="ml-1.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18l6-6-6-6"></path>
            </svg>
          </a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="projectsGrid">
          {% for project in projects %}
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 hover:shadow-md transition-all flex flex-col h-full {% if forloop.counter > 8 %}hidden extra-project{% endif %}">
              <!-- Top Accent -->
              <div class="w-full h-1 bg-blue-500"></div>

              <div class="p-5 relative flex flex-col justify-between h-full">
                <!-- Favorite Button -->
                <button onclick="saveProject({{ project.id }})" id="fav-btn-{{ project.id }}" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 focus:outline-none transition-all" aria-label="{% if project.id in favorite_ids %}Remove from favorites{% else %}Add to favorites{% endif %}">
                  {% if project.id in favorite_ids %}
                    <i class="fas fa-heart text-red-500"></i>
                  {% else %}
                    <i class="far fa-heart text-gray-400 hover:text-red-400"></i>
                  {% endif %}
                </button>

                <!-- Categories & Badges -->
                <div class="flex flex-wrap gap-1.5 mb-3">
                  {% if project.view_count > 500 %}
                    <span class="inline-flex items-center px-2 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full">
                      <i class="fas fa-fire-alt mr-1"></i> Trending
                    </span>
                  {% endif %}

                  {% for category in project.category.all %}
                    <a href="#" onclick="setCategoryFilter('{{ category.id }}')" class="inline-flex items-center px-2 py-0.5 bg-gray-100 hover:bg-gray-200 text-xs font-medium rounded-full text-gray-700 transition-colors">
                      {{ category.name }}
                    </a>
                  {% endfor %}
                </div>

                <!-- Project Title -->
                <a href="{% url 'project-detail' project.id %}" class="block text-lg font-semibold mb-2 text-gray-800 hover:text-blue-600 line-clamp-2">
                  {{ project.title }}
                </a>

                <!-- Posted Date -->
                <div class="text-xs text-gray-500 mb-3">
                  <i class="fas fa-clock mr-1.5 text-gray-400"></i> Posted {{ project.created_at|timesince }} ago
                </div>

                <!-- Description -->
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                  {{ project.description }}
                </p>

                <!-- Project Owner -->
                <div class="flex items-center gap-2 mb-4 p-2 bg-gray-50 rounded-lg">
                  <a href="{% url 'project-user-profile' project.owner.username %}">
                    <img src="{{ project.owner.profile.avatar_url }}" alt="{{ project.owner.username }}" class="w-8 h-8 rounded-full object-cover">
                  </a>
                  <div>
                    <a href="{% url 'project-user-profile' project.owner.username %}" class="text-sm font-medium text-gray-800 hover:text-blue-600">
                      @{{ project.owner.username }}
                    </a>
                    {% if project.owner.profile.city or project.owner.profile.country %}
                      <p class="text-xs text-gray-500 flex items-center">
                        <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>
                        {% if project.owner.profile.city %}{{ project.owner.profile.city }}{% endif %}
                        {% if project.owner.profile.city and project.owner.profile.country %} · {% endif %}
                        {% if project.owner.profile.country %}{{ project.owner.profile.country }}{% endif %}
                      </p>
                    {% endif %}
                  </div>
                </div>

                <!-- View Details Button -->
                <div class="mt-auto">
  <a href="{% url 'project-detail' project.id %}" class="block w-full py-2 bg-blue-600 rounded-lg text-center font-medium text-white hover:bg-blue-700 transition-all">
    View Details
  </a>
</div>

              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Show More Button -->
        {% if projects|length > 8 %}
          <div class="text-center mt-8">
            <button id="showMoreBtn" class="px-6 py-2.5 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-all">
              Show More Projects
            </button>
          </div>
        {% endif %}
      </section>
    {% endif %}

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="flex justify-center mt-8">
        <nav class="inline-flex rounded-md shadow-sm">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
              <i class="fas fa-chevron-left text-xs mr-1"></i> Previous
            </a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-700">
                {{ num }}
              </span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                {{ num }}
              </a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
              Next <i class="fas fa-chevron-right text-xs ml-1"></i>
            </a>
          {% endif %}
        </nav>
      </div>
    {% endif %}




  </div>

  <!-- Filter Modal Dialog -->
  <div id="filterDialog" class="fixed inset-0 z-50 hidden modal flex items-center justify-center">
    <div class="absolute inset-0 bg-black bg-opacity-30" onclick="toggleFilterDialog()"></div>
    <div class="modal-content bg-white rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 m-4 relative z-10">

      <!-- Close Button -->
      <button type="button" onclick="toggleFilterDialog()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
        <i class="fas fa-times"></i>
      </button>

      <h3 class="text-xl font-semibold mb-6">Filter Projects</h3>

      <form id="filterForm" method="GET" class="space-y-6" onsubmit="applyFilters(event)">
        <!-- Time Filter -->
        <div>
          <label class="block text-sm font-medium mb-2">Filter by Time:</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" onclick="setTimeFilter('')" id="time-any" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Any Time</button>
            <button type="button" onclick="setTimeFilter('last_24_hours')" id="time-24" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Last Day</button>"
                                <!-- Continue from the last provided code -->
            <button type="button" onclick="setTimeFilter('last_week')" id="time-week" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Last Week</button>
            <button type="button" onclick="setTimeFilter('last_month')" id="time-month" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Last Month</button>
            <button type="button" onclick="setTimeFilter('last_year')" id="time-year" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Last Year</button>
            <button type="button" onclick="toggleCustomDate()" id="time-custom-btn" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">Custom Range</button>
          </div>
          <input type="hidden" id="time_filter" name="time_filter" value="{{ time_filter }}">
          <div id="custom-date-range" class="mt-3 hidden flex gap-3">
            <input type="date" name="date_from" id="date_from" class="w-1/2 px-3 py-1.5 border rounded-lg" value="{{ date_from }}">
            <input type="date" name="date_to" id="date_to" class="w-1/2 px-3 py-1.5 border rounded-lg" value="{{ date_to }}">
          </div>
        </div>

        <!-- Skills Filter -->
        <div class="relative">
          <label class="block text-sm font-medium mb-2">Filter by Skills:</label>
          <div class="relative">
            <input type="text" id="skills_search" class="w-full px-3 py-1.5 border rounded-lg" placeholder="Type a skill...">
            <div id="skills_suggestions" class="hidden absolute top-full left-0 right-0 bg-white border rounded-lg mt-1 max-h-40 overflow-y-auto z-10"></div>
          </div>
          <div id="selected_skills_container" class="mt-2 flex flex-wrap gap-2">
            {% for skill in selected_skills %}
              <span class="skill-tag">
                {{ skill }}
                <button type="button" onclick="removeSkillTag('{{ skill }}')" class="ml-1 text-gray-400 hover:text-gray-600">
                  &times;
                </button>
              </span>
            {% endfor %}
          </div>
          <input type="hidden" id="selected_skills" name="skills" value="{{ selected_skills|join:'||' }}">
        </div>

      <!-- Languages Filter -->
<div>
  <label class="block text-sm font-medium mb-2">Filter by Languages:</label>
  <div class="flex flex-wrap gap-2">
    <button type="button" onclick="toggleLanguageFilter('all')" id="lang-all" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">
      All Languages
    </button>
    {% for lang in languages %}
      <button type="button"
        onclick="toggleLanguageFilter('{{ lang.id }}')"
        id="lang-btn-{{ lang.id }}"
        class="px-3 py-1.5 rounded-full text-sm transition-all
        {% if lang.id|stringformat:"s" in selected_languages %}bg-blue-100 text-blue-700{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        {{ lang.name }}
      </button>
    {% endfor %}
  </div>
  <input type="hidden" id="filterSelectedLanguages" name="languages" value="{{ selected_languages|join:',' }}">
</div>


        <!-- Categories Filter -->
        <div>
          <label class="block text-sm font-medium mb-2">Filter by Categories:</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" onclick="toggleCategoryFilter('all')" id="cat-all" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-all">
              All Categories
            </button>
            {% for cat in all_categories %}
              <button type="button"
        onclick="toggleCategoryFilter('{{ cat.id }}')"
        id="cat-btn-{{ cat.id }}"
        class="px-3 py-1.5 rounded-full text-sm transition-all
        {% if cat.id|stringformat:"s" in selected_categories %}bg-blue-100 text-blue-700{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
  {{ cat.name }}
</button>

            {% endfor %}
          </div>
          <input type="hidden" id="filterSelectedCategories" name="categories" value="{{ selected_categories|join:',' }}">
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end gap-3 pt-6">
          <button type="button" onclick="clearFilters()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
            Clear Filters
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
            Apply Filters
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript Enhancements -->
  <script>
    // Show More Projects functionality
    document.getElementById('showMoreBtn')?.addEventListener('click', function() {
      const hiddenProjects = document.querySelectorAll('.extra-project');
      hiddenProjects.forEach(project => project.classList.remove('hidden'));
      this.style.display = 'none';
    });

    // Toggle description visibility
    function toggleDescription(descId, event) {
      const desc = document.getElementById(descId);
      const btn = event.currentTarget;
      const [readMore, readLess] = btn.querySelectorAll('span');
      const [downIcon, upIcon] = btn.querySelectorAll('i');

      desc.classList.toggle('line-clamp-3');
      readMore.classList.toggle('hidden');
      readLess.classList.toggle('hidden');
      downIcon.classList.toggle('hidden');
      upIcon.classList.toggle('hidden');
    }

    // Filter Modal Interactions
    function toggleFilterDialog() {
      const dialog = document.getElementById('filterDialog');
      dialog.classList.toggle('hidden');
      document.body.classList.toggle('overflow-hidden', !dialog.classList.contains('hidden'));
    }

    // Time Filter Handling
    function setTimeFilter(value) {
      document.getElementById('time_filter').value = value;
      // Update button states
      document.querySelectorAll('[id^="time-"]').forEach(btn =>
        btn.classList.remove('bg-blue-100', 'text-blue-700')
      );
      if (value) document.getElementById(`time-${value}`)?.classList.add('bg-blue-100', 'text-blue-700');
    }

    // Skill Suggestions
    document.getElementById('skills_search')?.addEventListener('input', async function() {
      const query = this.value;
      if (query.length < 2) {
        document.getElementById('skills_suggestions').classList.add('hidden');
        return;
      }

      const response = await fetch(`{% url 'search-skills' %}?query=${encodeURIComponent(query)}`);
      const { skills } = await response.json();

      const suggestions = skills.map(skill => `
        <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
             onclick="addSkillTag('${skill.name}')">
          ${skill.name.replace(new RegExp(query, 'gi'), match => `<strong>${match}</strong>`)}
        </div>
      `).join('');

      const container = document.getElementById('skills_suggestions');
      container.innerHTML = suggestions;
      container.classList.remove('hidden');
    });

    // Category Filter Toggle
    function toggleCategoryFilter(catId) {
  const input = document.getElementById('filterSelectedCategories');
  let selected = input.value.split(',').filter(Boolean);

  const index = selected.indexOf(catId);
  const button = document.getElementById(`cat-btn-${catId}`);

  if (index > -1) {
    selected.splice(index, 1);
    button.classList.remove('bg-blue-100', 'text-blue-700');
    button.classList.add('bg-gray-100', 'hover:bg-gray-200');
  } else {
    selected.push(catId);
    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
    button.classList.add('bg-blue-100', 'text-blue-700');
  }

  input.value = selected.join(',');
}

// Language Filter Toggle
function toggleLanguageFilter(langId) {
  const input = document.getElementById('filterSelectedLanguages');
  let selected = input.value.split(',').filter(Boolean);

  const index = selected.indexOf(langId);
  const button = document.getElementById(`lang-btn-${langId}`);

  if (index > -1) {
    selected.splice(index, 1);
    button.classList.remove('bg-blue-100', 'text-blue-700');
    button.classList.add('bg-gray-100', 'hover:bg-gray-200');
  } else {
    selected.push(langId);
    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
    button.classList.add('bg-blue-100', 'text-blue-700');
  }

  input.value = selected.join(',');
}



    // Initialize Filters
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial filter states
      const timeFilter = '{{ time_filter }}';
      if (timeFilter) setTimeFilter(timeFilter);

      // Set initial category states
      '{{ selected_categories|join:"," }}'.split(',').forEach(catId => {
        if (catId) document.getElementById(`cat-btn-${catId}`)?.classList.add('bg-blue-100', 'text-blue-700');
      });
    });

    // WebSocket for real-time updates
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      // Update notification badges
      if (data.unread_count !== undefined) {
        const badge = document.getElementById('unread-count-badge');
        if (badge) {
          badge.textContent = data.unread_count;
          badge.style.display = data.unread_count > 0 ? 'flex' : 'none';
        }
      }
    };


    // --- Skill Suggestions (Search + Select) ---
document.getElementById('skills_search')?.addEventListener('input', async function() {
  const query = this.value;
  const suggestionsBox = document.getElementById('skills_suggestions');
  if (query.length < 2) {
    suggestionsBox.classList.add('hidden');
    return;
  }
  const response = await fetch(`{% url 'search-skills' %}?query=${encodeURIComponent(query)}`);
  const { skills } = await response.json();
  suggestionsBox.innerHTML = skills.map(skill => `
    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
         onclick="addSkillTag('${skill.name}')">
      ${skill.name.replace(new RegExp(query, 'gi'), match => `<strong>${match}</strong>`)}
    </div>
  `).join('');
  suggestionsBox.classList.remove('hidden');
});

// --- Add Skill Tag ---
function addSkillTag(skillName) {
  const selectedSkillsInput = document.getElementById('selected_skills');
  let selectedSkills = selectedSkillsInput.value.split('||').filter(Boolean);

  if (!selectedSkills.includes(skillName)) {
    selectedSkills.push(skillName);
    selectedSkillsInput.value = selectedSkills.join('||');
    const container = document.getElementById('selected_skills_container');
    const tag = document.createElement('span');
    tag.className = 'skill-tag flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm';
    tag.innerHTML = `${skillName}<button type="button" onclick="removeSkillTag('${skillName}')" class="ml-2 text-gray-400 hover:text-gray-600">&times;</button>`;
    container.appendChild(tag);
  }
  document.getElementById('skills_suggestions').classList.add('hidden');
  document.getElementById('skills_search').value = '';
}

// --- Remove Skill Tag ---
function removeSkillTag(skillName) {
  const selectedSkillsInput = document.getElementById('selected_skills');
  let selectedSkills = selectedSkillsInput.value.split('||').filter(Boolean);

  selectedSkills = selectedSkills.filter(skill => skill !== skillName);
  selectedSkillsInput.value = selectedSkills.join('||');

  const container = document.getElementById('selected_skills_container');
  container.innerHTML = '';
  selectedSkills.forEach(skill => addSkillTag(skill));
}

// --- Clear All Filters ---
function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('time_filter').value = '';
  document.getElementById('filterSelectedCategories').value = '';
  document.getElementById('filterSelectedLanguages').value = '';
  document.getElementById('selected_skills').value = '';
  document.getElementById('date_from').value = '';
  document.getElementById('date_to').value = '';
  document.getElementById('selected_skills_container').innerHTML = '';

  document.querySelectorAll('.bg-blue-100').forEach(btn => {
    btn.classList.remove('bg-blue-100', 'text-blue-700');
    btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
  });
}

  </script>

</body>
</html>
{% endblock %}
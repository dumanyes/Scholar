{% extends "users/base.html" %}
{% load static %}
{% load project_tags %}

{% block content %}
<div class="max-w-3xl mx-auto p-8">
  <h1 class="text-2xl font-bold mb-6">
    {% if object %}Update Project{% else %}Create Project{% endif %}
  </h1>

  <form method="post" class="space-y-8" id="project-form">
    {% csrf_token %}

    {# Non-field errors #}
    {% if form.non_field_errors %}
      <div class="mb-4 p-2 text-red-600 text-sm">
        {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Title -->
    <div>
      <label for="project-title" class="block text-sm font-medium text-gray-700 mb-2">
        Project Title
      </label>
      <input
        id="project-title"
        type="text"
        name="title"
        value="{{ form.title.value|default_if_none:'' }}"
        class="w-full px-4 py-2 border border-gray-200 rounded-lg"
        placeholder="Enter project title"
      />
      <div id="title-counter" class="mt-1 text-sm text-gray-500">0/20 words</div>
      {% if form.title.errors %}
        <div class="text-red-600 text-sm mt-1">
          {% for error in form.title.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Description -->
    <div>
      <label for="project-description" class="block text-sm font-medium text-gray-700 mb-2">
        Project Description
      </label>
      <textarea
        id="project-description"
        name="description"
        class="w-full px-4 py-2 border border-gray-200 rounded-lg"
      >{{ form.description.value|default_if_none:'' }}</textarea>
      <div id="description-counter" class="mt-1 text-sm text-gray-500">0/250 words</div>
      {% if form.description.errors %}
        <div class="text-red-600 text-sm mt-1">
          {% for error in form.description.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Mission -->
    <div>
      <label for="project-mission" class="block text-sm font-medium text-gray-700 mb-2">
        Project Mission (max 70 words)
      </label>
      <textarea
        id="project-mission"
        name="project_mission"
        class="w-full px-4 py-2 border border-gray-200 rounded-lg"
      >{{ form.project_mission.value|default_if_none:'' }}</textarea>
      <div id="mission-counter" class="mt-1 text-sm text-gray-500">0/70 words</div>
      {% if form.project_mission.errors %}
        <div class="text-red-600 text-sm mt-1">
          {% for error in form.project_mission.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Objectives -->
    <div>
      <label for="project-objectives" class="block text-sm font-medium text-gray-700 mb-2">
        Project Objectives (max 150 words)
      </label>
      <textarea
        id="project-objectives"
        name="project_objectives"
        class="w-full px-4 py-2 border border-gray-200 rounded-lg"
      >{{ form.project_objectives.value|default_if_none:'' }}</textarea>
      <div id="objectives-counter" class="mt-1 text-sm text-gray-500">0/150 words</div>
      {% if form.project_objectives.errors %}
        <div class="text-red-600 text-sm mt-1">
          {% for error in form.project_objectives.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Link (optional) -->
    <div>
      <label for="project-link" class="block text-sm font-medium text-gray-700 mb-2">
        Project Link (optional)
      </label>
      <input
        id="project-link"
        type="url"
        name="project_link"
        value="{{ form.project_link.value|default_if_none:'' }}"
        class="w-full px-4 py-2 border border-gray-200 rounded-lg"
        placeholder="Enter project link"
      />
      {% if form.project_link.errors %}
        <div class="text-red-600 text-sm mt-1">
          {% for error in form.project_link.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Categories (max 5) -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Project Categories (max 5)
      </label>
      <div id="categories-buttons" class="flex flex-wrap gap-2 mb-4">
        {% for category in available_categories %}
          <button
            type="button"
            class="px-4 py-2 rounded-full text-sm border category-btn
            {% if category.id in selected_categories_list %}
               bg-blue-100 text-blue-700 border-blue-200
            {% else %}
               bg-gray-50 text-gray-700 border-gray-200
            {% endif %}"
            data-id="{{ category.id }}"
          >
            {{ category.name }}
          </button>
        {% endfor %}
      </div>
      <input type="hidden" name="categories" id="categories-hidden" value="{{ selected_categories }}">
    </div>

    <!-- Required Skills -->
    <!-- Required Skills -->
<div>
  <label class="block text-sm font-medium text-gray-700 mb-2">
    Required Skills (select at least 1)
  </label>
  <input type="hidden" name="skills_required" id="skills-hidden" value="{{ form.skills_required.value|default:'' }}">

  <!-- Selected Skills Display -->
  <div id="skills-display" class="flex flex-wrap gap-2 mb-4">
    {% for skill_id in form.skills_required.value|split:"," %}
      {% if skill_id %}
        {% with skill=skill_id|get_skill %}
          {% if skill %}
            <span class="px-4 py-2 rounded-xl text-sm font-medium bg-blue-100 text-blue-700 border border-blue-200 skill-tag">
              {{ skill.name }}
              <button type="button" class="ml-2 text-blue-500 hover:text-blue-700 remove-skill" data-id="{{ skill.id }}">&times;</button>
            </span>
          {% endif %}
        {% endwith %}
      {% endif %}
    {% endfor %}
  </div>

  <!-- Search Input -->
  <div class="relative">
    <input
      type="text"
      id="skills-search"
      class="w-full px-4 py-2 border border-gray-200 rounded-lg"
      placeholder="Search skills..."
      autocomplete="off"
    >
    <div id="skills-results" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
  </div>

  {% if form.skills_required.errors %}
    <div class="text-red-600 text-sm mt-1">
      {% for error in form.skills_required.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>
    <!-- Project Languages -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Project Languages
      </label>
      <div id="languages-buttons" class="flex flex-wrap gap-2 mb-4">
        {% for lang in languages %}
          <button
            type="button"
            class="px-4 py-2 rounded-full text-sm border language-btn
            {% if lang.id in selected_languages_list %}
               bg-blue-100 text-blue-700 border-blue-200
            {% else %}
               bg-gray-50 text-gray-700 border-gray-200
            {% endif %}"
            data-id="{{ lang.id }}"
          >
            {{ lang.name }}
          </button>
        {% endfor %}
      </div>
      <input type="hidden" name="languages" id="languages-hidden" value="{{ selected_languages }}">
    </div>

    <!-- Required Roles -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Required Roles
      </label>
      <div id="roles-buttons" class="flex flex-wrap gap-2 mb-4">
        {% for role in required_roles %}
          <button
            type="button"
            class="px-4 py-2 rounded-full text-sm border role-btn
            {% if role.id in selected_required_roles_list %}
               bg-blue-100 text-blue-700 border-blue-200
            {% else %}
               bg-gray-50 text-gray-700 border-gray-200
            {% endif %}"
            data-id="{{ role.id }}"
          >
            {{ role.name }}
          </button>
        {% endfor %}
      </div>
      <input type="hidden" name="required_roles" id="roles-hidden" value="{{ selected_required_roles }}">
    </div>

    <!-- Submit -->
    <button
      type="submit"
      id="submit-button"
      class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-medium"
    >
      {% if object %}Update Project{% else %}Create Project{% endif %}
    </button>
  </form>
</div>

<!-- Debug Information (Optional) -->
<div id="debug-info" style="background:#f9f9f9; padding:10px; margin-top:20px;">
  <h4 class="font-bold mb-2">Debug Information</h4>
  <p>Selected Categories: {{ selected_categories_list }}</p>
  <p>Selected Languages: {{ selected_languages_list }}</p>
  <p>Selected Roles: {{ selected_required_roles_list }}</p>
  <p>Skills Value: {{ form.skills_required.value }}</p>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Word counters
  function wordCounter(inputId, counterId, max) {
    const input = document.getElementById(inputId);
    const counter = document.getElementById(counterId);

    function update() {
      const words = input.value.trim().split(/\s+/).filter(Boolean);
      counter.textContent = `${words.length}/${max} words`;
    }

    update();
    input.addEventListener('input', update);
  }

  wordCounter('project-title', 'title-counter', 20);
  wordCounter('project-description', 'description-counter', 250);
  wordCounter('project-mission', 'mission-counter', 70);
  wordCounter('project-objectives', 'objectives-counter', 150);

  // Selection manager
  function setupSelection(buttonSelector, hiddenInputId, max = Infinity) {
    const buttons = document.querySelectorAll(buttonSelector);
    const hiddenInput = document.getElementById(hiddenInputId);
    let selected = new Set(hiddenInput.value ? hiddenInput.value.split(',') : []);

    // Initialize button states
    buttons.forEach(btn => {
      if (selected.has(btn.dataset.id)) {
        btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-200');
        btn.classList.remove('bg-gray-50', 'text-gray-700', 'border-gray-200');
      }
    });

    // Toggle selection
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;

        if (selected.has(id)) {
          selected.delete(id);
          btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-200');
          btn.classList.add('bg-gray-50', 'text-gray-700', 'border-gray-200');
        } else {
          if (selected.size < max) {
            selected.add(id);
            btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-200');
            btn.classList.remove('bg-gray-50', 'text-gray-700', 'border-gray-200');
          } else {
            alert(`Maximum ${max} selections allowed`);
          }
        }

        hiddenInput.value = Array.from(selected).join(',');
      });
    });
  }

  // Initialize selections
  setupSelection('.category-btn', 'categories-hidden', 5);
  setupSelection('.language-btn', 'languages-hidden');
  setupSelection('.role-btn', 'roles-hidden');
});
</script>
{% endblock %}
{% extends "users/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Edit Profile{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet" />

<div class="container my-8">
  <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-center text-2xl font-bold mb-6">
      <i class="fas fa-user-edit mr-2"></i>Edit Profile
    </h2>
    <form method="post" action="{% url 'users-edit-profile' %}" enctype="multipart/form-data" id="profile-form">
      {% csrf_token %}

      <!-- Avatar Section -->
      <div class="flex flex-col items-center mb-6">
        <div class="relative">
          <img class="w-24 h-24 object-cover rounded-full border border-gray-300" 
               src="{{ user.profile.avatar.url }}" 
               alt="Profile Picture" 
               onerror="this.src='/static/images/default-avatar.png'">
          <label class="absolute bottom-0 right-0 bg-gray-800 text-white p-2 rounded-full cursor-pointer hover:bg-gray-700" title="Upload new photo">
            <i class="fas fa-camera"></i>
            {{ profile_form.avatar|add_class:"hidden" }}
          </label>
        </div>
        {% if profile_form.avatar.errors %}
          <p class="text-red-600 text-sm mt-2">{{ profile_form.avatar.errors|join:", " }}</p>
        {% endif %}
      </div>

      <!-- Personal Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-gray-700">Username</label>
          {{ user_form.username|add_class:"w-full px-3 py-2 border rounded" }}
          {% if user_form.username.errors %}
            <p class="text-red-600 text-sm mt-1">{{ user_form.username.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-700">Email</label>
          {{ user_form.email|add_class:"w-full px-3 py-2 border rounded" }}
          {% if user_form.email.errors %}
            <p class="text-red-600 text-sm mt-1">{{ user_form.email.errors|join:", " }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Professional Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-gray-700">Organization</label>
          {{ profile_form.organization|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.organization.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.organization.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-700">Position</label>
          {{ profile_form.position|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.position.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.position.errors|join:", " }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Biography -->
      <div class="mb-4">
        <label class="block text-gray-700">Biography</label>
        {{ profile_form.bio|add_class:"w-full px-3 py-2 border rounded" }}
        <small class="text-gray-500">Tell us about your academic journey</small>
        {% if profile_form.bio.errors %}
          <p class="text-red-600 text-sm mt-1">{{ profile_form.bio.errors|join:", " }}</p>
        {% endif %}
      </div>

      <!-- University with Search -->
      <div class="mb-4">
  <label class="block text-gray-700">University</label>
  <select name="university" id="id_university" class="w-full px-3 py-2 border rounded">
    <option value="">Select a University</option>
    {% for uni in universities %}
      <option value="{{ uni.id }}"
        {% if user.profile.university and user.profile.university.id == uni.id %}selected{% endif %}>
        {{ uni.name }}
      </option>
    {% endfor %}
  </select>
  {% if profile_form.university.errors %}
    <p class="text-red-600 text-sm mt-1">{{ profile_form.university.errors|join:", " }}</p>
  {% endif %}
</div>


      <!-- Dynamic Location Selection -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- Country with Search -->
        <div>
          <label class="block text-gray-700">Country</label>
          <input type="text" id="country-search" placeholder="Search Country" class="mb-2 w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          <select name="country" id="id_country" class="w-full px-3 py-2 border rounded">
            <option value="">Select a country</option>
            {% for country in countries %}
              <option value="{{ country.id }}"
                {% if user.profile.country and user.profile.country.id == country.id %}selected{% endif %}>
                {{ country.name }}
              </option>
            {% endfor %}
          </select>
          {% if profile_form.country.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.country.errors|join:", " }}</p>
          {% endif %}
        </div>
        <!-- City with Search -->
        <div>
          <label class="block text-gray-700">City</label>
          <input type="text" id="city-search" placeholder="Search City" class="mb-2 w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
          <select name="city" id="id_city" class="w-full px-3 py-2 border rounded">
            <option value="">Select a city</option>
            {% for city in cities %}
              <option value="{{ city.id }}" data-country="{{ city.country.id }}"
                {% if user.profile.city and user.profile.city.id == city.id %}selected{% endif %}>
                {{ city.name }}
              </option>
            {% endfor %}
          </select>
          {% if profile_form.city.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.city.errors|join:", " }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Categories Selection (Replaces Interests) -->
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Your Categories</label>
        <div id="categories-buttons" class="flex flex-wrap gap-2 mb-2">
          {% for category in available_categories %}
            <button type="button"
                    class="px-4 py-2 rounded-full text-sm transition border bg-gray-50 text-gray-700 border-gray-200"
                    data-id="{{ category.id }}">
              {{ category.name }}
            </button>
          {% endfor %}
        </div>
        <input type="hidden" name="categories" id="categories-hidden" value="{{ profile_form.initial.categories }}">
        {% if profile_form.categories.errors %}
          <p class="text-red-600 text-sm mt-1">{{ profile_form.categories.errors|join:", " }}</p>
        {% endif %}
      </div>

      <!-- Skills Selection -->
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">
          Your Skills (Select at least 1 skill)
        </label>
        <div class="space-y-2">
          {% for category in skill_categories %}
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <details class="group">
                <summary class="flex justify-between items-center p-4 cursor-pointer bg-gray-50">
                  <span class="font-medium">{{ category.name }}</span>
                  <svg class="w-5 h-5 transition-transform group-open:rotate-180" viewBox="0 0 24 24">
                    <path d="M7 10l5 5 5-5z" />
                  </svg>
                </summary>
                <div class="p-4 space-y-4">
                  {% for subcat in category.subcategories.all %}
                    <details class="group/sub">
                      <summary class="flex justify-between items-center p-2 cursor-pointer">
                        <span class="font-medium">{{ subcat.name }}</span>
                        <svg class="w-4 h-4 transition-transform group-open/sub:rotate-180" viewBox="0 0 24 24">
                          <path d="M7 10l5 5 5-5z" />
                        </svg>
                      </summary>
                      <div class="mt-2 space-y-2">
                        {% for skill in subcat.skills.all %}
                          <div class="p-2 rounded-md cursor-pointer transition hover:bg-gray-50 skill-item"
                               data-skill-id="{{ skill.id }}" data-skill-name="{{ skill.name }}">
                            {{ skill.name }}
                          </div>
                        {% endfor %}
                      </div>
                    </details>
                  {% endfor %}
                </div>
              </details>
            </div>
          {% endfor %}
        </div>
        <input type="hidden" name="skills" id="skills-hidden" value="{{ profile_form.initial.skills|default:"" }}">
        <!-- Selected Skills Display -->
        <div id="selected-skills-display" class="mt-3 flex flex-wrap gap-2"></div>
        {% if profile_form.skills.errors %}
          <p class="text-red-600 text-sm mt-1">{{ profile_form.skills.errors|join:", " }}</p>
        {% endif %}
      </div>

      <!-- Contact Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-gray-700">LinkedIn</label>
          {{ profile_form.linkedin|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.linkedin.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.linkedin.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-700">GitHub</label>
          {{ profile_form.github|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.github.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.github.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-700">Google Scholar</label>
          {{ profile_form.google_scholar|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.google_scholar.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.google_scholar.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-gray-700">Telegram</label>
          {{ profile_form.telegram|add_class:"w-full px-3 py-2 border rounded" }}
          {% if profile_form.telegram.errors %}
            <p class="text-red-600 text-sm mt-1">{{ profile_form.telegram.errors|join:", " }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Form Actions -->
      <div class="flex justify-between">
        <a href="{% url 'users-profile' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition inline-flex items-center">
          <i class="fas fa-times mr-2"></i>Cancel
        </a>
        <button type="submit" id="save-button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition inline-flex items-center">
          <i class="fas fa-save mr-2"></i>Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript Section -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const saveButton = document.getElementById('save-button');

  // --- Categories Selection ---
  // --- Categories Selection ---
const categoryButtons = document.querySelectorAll('#categories-buttons button');
const categoriesHidden = document.getElementById('categories-hidden');
// Read initial value from the hidden field (it should be set by the form's __init__)
let selectedCategories = categoriesHidden.value ? categoriesHidden.value.split(",").filter(v => v) : [];

// On page load, update the UI for already selected categories:
selectedCategories.forEach(id => {
  const btn = document.querySelector(`#categories-buttons button[data-id="${id}"]`);
  if (btn) {
    btn.classList.remove('bg-gray-50','text-gray-700','border-gray-200');
    btn.classList.add('bg-blue-100','text-blue-700','border-blue-200');
  }
});

// Add click event listeners
categoryButtons.forEach(button => {
  button.addEventListener('click', function() {
    const id = button.getAttribute('data-id');
    if (selectedCategories.includes(id)) {
      // Remove the selection
      selectedCategories = selectedCategories.filter(cid => cid !== id);
      button.classList.remove('bg-blue-100','text-blue-700','border-blue-200');
      button.classList.add('bg-gray-50','text-gray-700','border-gray-200');
    } else {
      // Add the selection
      selectedCategories.push(id);
      button.classList.remove('bg-gray-50','text-gray-700','border-gray-200');
      button.classList.add('bg-blue-100','text-blue-700','border-blue-200');
    }
    categoriesHidden.value = selectedCategories.join(",");
  });
});


  // --- Skills Selection & Display with Removable Tags ---
  const skillsHidden = document.getElementById('skills-hidden');
  let selectedSkills = skillsHidden.value ? skillsHidden.value.split(",") : [];
  const skillItems = document.querySelectorAll('.skill-item');
  const selectedSkillsDisplay = document.getElementById('selected-skills-display');

  function updateSelectedSkillsDisplay() {
    selectedSkillsDisplay.innerHTML = "";
    selectedSkills.forEach(skillId => {
      const skillElement = document.querySelector(`.skill-item[data-skill-id="${skillId}"]`);
      if (skillElement) {
        const skillName = skillElement.getAttribute('data-skill-name');
        const tag = document.createElement('span');
        tag.className = "inline-flex items-center bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-sm cursor-pointer";
        tag.textContent = skillName;
        tag.addEventListener('click', () => {
          selectedSkills = selectedSkills.filter(id => id !== skillId);
          skillsHidden.value = selectedSkills.join(",");
          skillElement.classList.remove('bg-blue-50','text-blue-700');
          updateSelectedSkillsDisplay();
          checkFormValidity();
        });
        selectedSkillsDisplay.appendChild(tag);
      }
    });
  }
  selectedSkills.forEach(id => {
    const el = document.querySelector(`.skill-item[data-skill-id="${id}"]`);
    if (el) {
      el.classList.add('bg-blue-50','text-blue-700');
    }
  });
  updateSelectedSkillsDisplay();

  skillItems.forEach(item => {
    item.addEventListener('click', function() {
      const skillId = item.getAttribute('data-skill-id');
      if (selectedSkills.includes(skillId)) {
        selectedSkills = selectedSkills.filter(id => id !== skillId);
        item.classList.remove('bg-blue-50','text-blue-700');
      } else {
        selectedSkills.push(skillId);
        item.classList.add('bg-blue-50','text-blue-700');
      }
      skillsHidden.value = selectedSkills.join(",");
      updateSelectedSkillsDisplay();
      checkFormValidity();
    });
  });

  // --- Dynamic Location: Country and City Filtering ---
  const countrySearch = document.getElementById('country-search');
  const countrySelect = document.getElementById('id_country');
  const citySearch = document.getElementById('city-search');
  const citySelect = document.getElementById('id_city');

  countrySearch.addEventListener('keyup', function() {
    const filter = countrySearch.value.toLowerCase();
    Array.from(countrySelect.options).forEach(option => {
      const text = option.text.toLowerCase();
      option.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  function filterCities() {
    const selectedCountryId = countrySelect.value;
    const filter = citySearch.value.toLowerCase();
    Array.from(citySelect.options).forEach(option => {
      const optionCountry = option.getAttribute('data-country');
      const text = option.text.toLowerCase();
      if ((selectedCountryId === "" || optionCountry === selectedCountryId) && text.includes(filter)) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    });
  }
  countrySelect.addEventListener('change', filterCities);
  citySearch.addEventListener('keyup', filterCities);

  // --- Form Validation: Disable Save if Required Fields are Missing ---
  function checkFormValidity() {
    // Require at least one skill selected.
    if (selectedSkills.length < 1) {
      saveButton.disabled = true;
      saveButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
      saveButton.disabled = false;
      saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
  }
  checkFormValidity();

  // Prevent form submission if button is disabled.
  const profileForm = document.getElementById('profile-form');
  profileForm.addEventListener('submit', function(e) {
    checkFormValidity();
    if (saveButton.disabled) {
      e.preventDefault();
      alert('Please fix the errors before submitting the form.');
    }
  });
});
</script>
{% endblock %}
